/*********************************************************************************
  *Copyright(C), KEBODA TECHNOLOGY CO.,LTD.
  *FileName:    SystemLinDiag.c
  *Author:      Leo Song
  *Version:     0.0.1
  *Date:        2017.10.24
  *Description: This file manage LIN slave receive and response functions.
  *Others:      None.
  *History:
     1.Date:         2017.10.24
       Author:       Leo song
       Modification: Initial version.
                     V01: systemLinCommSignalUpdate will return LIN signal update status.
                          modified by Leo, Song. 2018.1.12
**********************************************************************************/
#include "SystemLinComm.h"
#include "ModulePower.h"
#include "ModuleLed.h"
#include "SystemControl.h"
#include "SystemStatus.h"
#include "SystemDerating.h"
#include "ModuleFlash.h"


#include "linSlaveTask.h"
#include "linsNodeCfgIdentify.h"
//#include "linStackTask.h"
#include "SystemLinDiag.h"   //SW Version


SLinSignals oldLinData;


void local_SignalInit(void);


#define DMAX_COLOR_AMOUNT 197


#if 0
const uint8_t SourceColors[DMAX_COLOR_AMOUNT][3]={
{31, 224, 0},{34, 227, 6},{33, 232, 15},{35, 237, 24},{58, 255, 27},
{62, 255, 30},{68, 255, 32},{60, 255, 53},{32, 255, 58},{32, 255, 80},
{32, 255, 110},{32, 255, 112},{70, 255, 148},{32, 255, 138},{60, 255, 160},
{32, 255, 168},{54, 235, 2},{56, 238, 13},{56, 242, 22},{60, 255, 38},
{78, 240, 45},{53, 255, 62},{84, 244, 17},{79, 245, 24},{79, 248, 34},
{80, 250, 188},{100, 228, 190},{123, 250, 33},{128, 252, 49},{30, 255, 115},
{36, 255, 245},{44, 230, 245},{162, 253, 46},{155, 253, 61},{83, 255, 38},
{110, 255, 35},{30, 255, 90},{32, 255, 200},{36, 255, 200},{62, 110, 255},
{199, 254, 51},{200, 254, 74},{140, 255, 36},{70, 255, 82},{32, 255, 148},
{122, 190, 190},{120, 100, 152},{120, 100, 188},{120, 100, 220},{120, 100, 240},
{150, 180, 13},{240, 255, 35},{255, 250, 34},{130, 88, 42},{103, 126, 37},
{103, 142, 58},{103, 152, 86},{103, 168, 120},{96, 177, 150},{96, 177, 177},
{96, 177, 178},{134, 70, 160},{134, 60, 177},{86, 50, 255},{200, 160, 13},
{220, 145, 13},{255, 200, 35},{134, 85, 55},{192, 178, 228},{177, 160, 239},
{162, 143, 246},{143, 123, 251},{255, 38, 160},{255, 52, 180},{255, 60, 190},
{73, 18, 220},{238, 136, 11},{245, 120, 11},{245, 105, 11},{255, 105, 20},
{255, 120, 23},{200, 72, 35},{223, 170, 196},{208, 156, 216},{194, 143, 228},
{175, 127, 240},{162, 113, 246},{220, 102, 115},{255, 70, 180},{255, 86, 190},
{144, 53, 177},{255, 88, 9},{255, 78, 9},{125, 23, 13},{239, 142, 158},
{231, 134, 178},{219, 122, 201},{204, 115, 219},{190, 99, 232},{174, 88, 242},
{144, 15, 65},{144, 15, 75},{144, 15, 85},{136, 18, 100},{255, 58, 7},
{254, 123, 54},{253, 122, 64},{251, 119, 84},{249, 115, 105},{245, 114, 125},
{239, 106, 150},{232, 97, 171},{220, 89, 197},{210, 79, 213},{199, 70, 227},
{185, 63, 239},{144, 12, 55},{255, 95, 37},{253, 92, 52},{252, 87, 62},
{255, 23, 16},{247, 83, 96},{243, 79, 119},{238, 74, 140},{231, 68, 163},
{224, 61, 184},{215, 55, 202},{205, 48, 221},{195, 39, 231},{187, 31, 238},
{179, 29, 243},{172, 27, 245},{169, 25, 245},{255, 76, 36},{253, 60, 45},
{251, 58, 57},{249, 59, 71},{244, 55, 91},{240, 54, 111},{235, 49, 132},
{229, 46, 152},{223, 42, 171},{214, 33, 189},{208, 28, 201},{201, 23, 214},
{194, 19, 218},{186, 18, 225},{183, 15, 225},{180, 13, 227},{254, 43, 26},
{252, 40, 36},{250, 37, 47},{246, 40, 63},{243, 39, 80},{238, 39, 100},
{232, 39, 120},{227, 37, 136},{220, 33, 152},{213, 30, 165},{208, 25, 171},
{201, 20, 184},{195, 16, 190},{190, 16, 188},{187, 13, 193},{184, 11, 191},
{254, 25, 18},{250, 25, 27},{248, 25, 41},{245, 29, 58},{241, 33, 75},
{236, 34, 93},{230, 36, 109},{224, 35, 124},{218, 33, 136},{211, 30, 145},
{207, 26, 156},{198, 23, 155},{193, 21, 155},{186, 18, 157},{184, 16, 155},
{182, 15, 153},{254, 10, 8},{251, 16, 22},{248, 21, 38},{245, 26, 52},
{240, 31, 73},{234, 34, 89},{229, 36, 105},{223, 36, 117},{217, 35, 126},
{210, 32, 133},{202, 29, 138},{195, 26, 138},{190, 24, 137},{185, 22, 134},
{181, 21, 130},{179, 20, 128}
};



const uint8_t KebodaColors[DMAX_COLOR_AMOUNT][3]={
{32, 198, 1},{34, 204, 1},{33, 202, 1},{32, 191, 2},{17, 185, 11},
{19, 181, 12},{18, 156, 11},{19, 214, 25},{68, 214, 47},{5, 162, 28},
{8, 244, 56},{4, 175, 42},{17, 172, 52},{7, 190, 56},{11, 164, 54},
{5, 147, 51},{39, 198, 1},{37, 184, 0},{42, 205, 2},{19, 181, 16},
{33, 247, 26},{14, 176, 24},{49, 196, 1},{49, 203, 2},{47, 196, 4},
{18, 178, 69},{30, 182, 76},{56, 175, 3},{63, 191, 6},{7, 217, 53},
{10, 207, 105},{10, 155, 87},{69, 178, 5},{59, 157, 7},{23, 167, 14},
{38, 208, 17},{6, 195, 38},{8, 183, 74},{8, 158, 96},{26, 213, 227},
{108, 241, 8},{93, 204, 11},{49, 198, 16},{16, 167, 30},{8, 210, 65},
{49, 204, 102},{69, 158, 118},{84, 210, 185},{73, 200, 206},{64, 202, 210},
{74, 190, 7},{81, 198, 15},{75, 167, 13},{158, 244, 60},{61, 173, 27},
{69, 218, 48},{47, 170, 51},{43, 181, 67},{34, 171, 75},{35, 172, 89},
{36, 170, 100},{120, 181, 186},{120, 165, 202},{43, 95, 177},{99, 174, 7},
{161, 240, 9},{98, 175, 16},{108, 167, 55},{107, 168, 51},{161, 242, 87},
{161, 231, 98},{161, 218, 112},{207, 111, 160},{192, 126, 166},{178, 139, 169},
{38, 65, 178},{175, 225, 9},{189, 208, 8},{200, 192, 8},{200, 195, 19},
{192, 213, 21},{206, 183, 43},{119, 160, 43},{180, 233, 78},{179, 224, 87},
{177, 213, 100},{177, 201, 112},{168, 213, 110},{174, 156, 158},{163, 168, 159},
{123, 159, 205},{209, 175, 7},{217, 158, 6},{237, 113, 28},{194, 211, 55},
{140, 146, 46},{201, 196, 80},{198, 192, 91},{200, 175, 107},{198, 163, 121},
{173, 54, 89},{238, 80, 143},{226, 85, 160},{212, 88, 176},{230, 128, 5},
{201, 192, 17},{202, 191, 21},{204, 188, 29},{207, 182, 38},{207, 181, 46},
{212, 173, 59},{217, 164, 72},{219, 155, 89},{222, 141, 103},{224, 127, 117},
{222, 117, 132},{179, 51, 78},{216, 161, 11},{218, 157, 18},{220, 150, 23},
{185, 45, 11},{224, 144, 39},{228, 138, 51},{171, 96, 46},{173, 88, 57},
{241, 110, 94},{243, 99, 109},{172, 60, 89},{173, 45, 98},{171, 30, 104},
{252, 40, 163},{251, 36, 170},{250, 35, 172},{227, 135, 12},{237, 111, 18},
{240, 107, 24},{240, 108, 31},{245, 101, 43},{177, 71, 39},{180, 64, 48},
{184, 61, 60},{183, 53, 68},{183, 36, 78},{193, 29, 91},{175, 21, 92},
{178, 22, 98},{176, 22, 104},{171, 22, 103},{172, 23, 107},{250, 83, 10},
{185, 56, 11},{191, 52, 16},{181, 54, 22},{186, 52, 29},{196, 55, 39},
{185, 50, 46},{207, 52, 60},{182, 38, 61},{182, 33, 69},{182, 24, 74},
{184, 20, 84},{178, 139, 170},{174, 20, 86},{192, 22, 98},{184, 21, 94},
{236, 41, 6},{185, 32, 8},{231, 39, 17},{186, 37, 21},{248, 54, 27},
{182, 44, 35},{187, 47, 43},{179, 44, 48},{181, 40, 56},{183, 36, 61},
{183, 28, 68},{184, 24, 72},{183, 20, 73},{181, 19, 76},{180, 19, 76},
{182, 19, 76},{226, 13, 1},{221, 21, 8},{224, 30, 15},{237, 41, 23},
{183, 39, 27},{183, 44, 34},{183, 47, 41},{187, 48, 47},{184, 46, 52},
{185, 39, 58},{181, 36, 60},{184, 32, 64},{184, 29, 65},{183, 26, 66},
{179, 24, 63},{180, 23, 64}
};
#endif



const uint8_t SourceColors[DMAX_COLOR_AMOUNT][3]={
{31, 224, 0},{34, 227, 6},{33, 232, 15},{35, 237, 24},{58, 255, 27},
{62, 255, 30},{68, 255, 32},{60, 255, 53},{32, 255, 58},{32, 255, 80},
{32, 255, 110},{32, 255, 112},{70, 255, 148},{32, 255, 138},{60, 255, 160},
{32, 255, 168},{54, 235, 2},{56, 238, 13},{56, 242, 22},{60, 255, 38},
{78, 240, 45},{53, 255, 62},{84, 244, 17},{79, 245, 24},{79, 248, 34},
{80, 250, 188},{100, 228, 190},{123, 250, 33},{128, 252, 49},{30, 255, 115},
{36, 255, 245},{44, 230, 245},{162, 253, 46},{155, 253, 61},{83, 255, 38},
{110, 255, 35},{30, 255, 90},{32, 255, 200},{36, 255, 200},{62, 110, 255},
{199, 254, 51},{200, 254, 74},{140, 255, 36},{70, 255, 82},{32, 255, 148},
{122, 190, 190},{120, 100, 152},{120, 100, 188},{120, 100, 220},{120, 100, 240},
{150, 180, 13},{240, 255, 35},{255, 250, 34},{130, 88, 42},{103, 126, 37},
{103, 142, 58},{103, 152, 86},{103, 168, 120},{96, 177, 150},{96, 177, 177},
{96, 177, 178},{134, 70, 160},{134, 60, 177},{86, 50, 255},{200, 160, 13},
{220, 145, 13},{255, 200, 35},{134, 85, 55},{192, 178, 228},{177, 160, 239},
{162, 143, 246},{143, 123, 251},{255, 38, 160},{255, 52, 180},{255, 60, 190},
{73, 18, 220},{238, 136, 11},{245, 120, 11},{245, 105, 11},{255, 105, 20},
{255, 120, 23},{200, 72, 35},{223, 170, 196},{208, 156, 216},{194, 143, 228},
{175, 127, 240},{162, 113, 246},{220, 102, 115},{255, 70, 180},{255, 86, 190},
{144, 53, 177},{255, 88, 9},{255, 78, 9},{125, 23, 13},{239, 142, 158},
{231, 134, 178},{219, 122, 201},{204, 115, 219},{190, 99, 232},{174, 88, 242},
{144, 15, 65},{144, 15, 75},{144, 15, 85},{136, 18, 100},{255, 58, 7},
{254, 123, 54},{253, 122, 64},{251, 119, 84},{249, 115, 105},{245, 114, 125},
{239, 106, 150},{232, 97, 171},{220, 89, 197},{210, 79, 213},{199, 70, 227},
{185, 63, 239},{144, 12, 55},{255, 95, 37},{253, 92, 52},{252, 87, 62},
{255, 23, 16},{247, 83, 96},{243, 79, 119},{238, 74, 140},{231, 68, 163},
{224, 61, 184},{215, 55, 202},{205, 48, 221},{195, 39, 231},{187, 31, 238},
{179, 29, 243},{172, 27, 245},{169, 25, 245},{255, 76, 36},{253, 60, 45},
{251, 58, 57},{249, 59, 71},{244, 55, 91},{240, 54, 111},{235, 49, 132},
{229, 46, 152},{223, 42, 171},{214, 33, 189},{208, 28, 201},{201, 23, 214},
{194, 19, 218},{186, 18, 225},{183, 15, 225},{180, 13, 227},{254, 43, 26},
{252, 40, 36},{250, 37, 47},{246, 40, 63},{243, 39, 80},{238, 39, 100},
{232, 39, 120},{227, 37, 136},{220, 33, 152},{213, 30, 165},{208, 25, 171},
{201, 20, 184},{195, 16, 190},{190, 16, 188},{187, 13, 193},{184, 11, 191},
{254, 25, 18},{250, 25, 27},{248, 25, 41},{245, 29, 58},{241, 33, 75},
{236, 34, 93},{230, 36, 109},{224, 35, 124},{218, 33, 136},{211, 30, 145},
{207, 26, 156},{198, 23, 155},{193, 21, 155},{186, 18, 157},{184, 16, 155},
{182, 15, 153},{254, 10, 8},{251, 16, 22},{248, 21, 38},{245, 26, 52},
{240, 31, 73},{234, 34, 89},{229, 36, 105},{223, 36, 117},{217, 35, 126},
{210, 32, 133},{202, 29, 138},{195, 26, 138},{190, 24, 137},{185, 22, 134},
{181, 21, 130},{179, 20, 128},
};



const uint8_t KebodaColors[DMAX_COLOR_AMOUNT][3]={
{40, 253, 0},{31, 189, 0},{40, 248, 0},{41, 243, 0},{18, 201, 17},
{20, 202, 19},{23, 203, 21},{20, 235, 47},{89, 246, 105},{4, 252, 78},
{5, 252, 109},{2, 251, 114},{23, 237, 142},{5, 242, 139},{13, 232, 154},
{4, 232, 159},{38, 188, 0},{39, 189, 0},{53, 252, 0},{21, 213, 29},
{31, 226, 39},{18, 245, 60},{67, 253, 0},{65, 253, 0},{64, 245, 1},
{21, 219, 173},{37, 208, 181},{89, 251, 1},{64, 177, 6},{4, 250, 117},
{6, 196, 209},{10, 184, 221},{109, 252, 7},{106, 252, 14},{30, 210, 27},
{41, 210, 27},{4, 254, 91},{5, 219, 179},{6, 176, 232},{9, 71, 185},
{128, 250, 10},{131, 252, 21},{58, 214, 28},{23, 253, 83},{5, 239, 145},
{50, 182, 196},{73, 132, 230},{43, 82, 175},{38, 78, 202},{29, 71, 184},
{110, 252, 12},{116, 249, 31},{129, 252, 33},{164, 208, 107},{74, 183, 53},
{88, 246, 106},{73, 230, 138},{58, 215, 163},{44, 201, 185},{42, 185, 205},
{40, 167, 216},{89, 94, 251},{59, 53, 181},{23, 31, 186},{157, 240, 13},
{177, 224, 13},{163, 250, 41},{150, 188, 133},{153, 195, 126},{116, 140, 110},
{145, 164, 155},{140, 147, 172},{122, 34, 169},{110, 41, 170},{138, 64, 235},
{20, 15, 188},{190, 204, 12},{202, 184, 12},{212, 165, 11},{213, 168, 32},
{205, 185, 36},{214, 148, 77},{175, 190, 109},{129, 133, 97},{165, 161, 140},
{158, 146, 158},{155, 131, 172},{147, 143, 170},{138, 80, 223},{94, 66, 165},
{59, 49, 181},{221, 148, 11},{229, 130, 11},{177, 58, 37},{196, 169, 96},
{193, 156, 111},{151, 112, 105},{180, 130, 146},{175, 110, 166},{169, 95, 183},
{207, 23, 190},{193, 24, 207},{178, 24, 224},{162, 25, 241},{242, 101, 10},
{214, 165, 28},{215, 163, 36},{216, 157, 52},{217, 148, 68},{214, 144, 83},
{211, 129, 103},{208, 114, 121},{200, 98, 144},{196, 81, 161},{192, 66, 178},
{184, 55, 195},{220, 23, 172},{228, 134, 20},{230, 128, 33},{233, 120, 42},
{174, 23, 20},{172, 81, 53},{230, 98, 91},{227, 86, 109},{222, 72, 129},
{217, 58, 150},{211, 44, 169},{156, 23, 144},{201, 11, 205},{199, 0, 217},
{193, 0, 225},{188, 0, 230},{186, 0, 233},{240, 107, 23},{179, 59, 24},
{180, 55, 33},{181, 55, 42},{181, 47, 57},{173, 42, 68},{240, 47, 116},
{234, 38, 136},{230, 27, 153},{226, 6, 175},{221, 0, 187},{213, 0, 199},
{208, 0, 206},{202, 0, 214},{199, 0, 217},{196, 0, 221},{235, 50, 18},
{225, 41, 26},{210, 32, 34},{181, 30, 40},{186, 27, 53},{184, 25, 67},
{177, 22, 80},{177, 18, 93},{240, 12, 145},{235, 5, 161},{233, 0, 169},
{225, 0, 182},{137, 64, 235},{218, 0, 192},{214, 0, 197},{215, 0, 197},
{119, 9, 7},{105, 7, 10},{67, 4, 10},{97, 8, 20},{149, 15, 30},
{183, 19, 64},{187, 21, 79},{170, 16, 82},{244, 16, 136},{241, 10, 146},
{239, 0, 159},{236, 0, 164},{235, 0, 166},{231, 0, 172},{230, 0, 173},
{231, 0, 172},{57, 0, 0},{41, 0, 3},{21, 1, 3},{39, 2, 7},
{167, 15, 45},{186, 20, 62},{179, 20, 72},{250, 27, 115},{246, 24, 125},
{245, 13, 138},{173, 7, 103},{242, 4, 151},{241, 1, 154},{241, 0, 156},
{242, 0, 153},{242, 0, 153},
};







/*--- LIN Product Identification --------------------------------------*/


/**
*@details   LIN common communication initialization.
*
*@params[in] newNad new single address.
*
*@retval    None.
*/
void systemLinCommChangeNad(uint8_t newNad)
{
//  SlaveNodeNAD = savedConfig.singleAddr;
  ls_set_initialNad(newNad);
  ls_set_nad(newNad);
  
  LNCI_Init();   // change state frame
}





void local_ColorMap(void)
{
  uint16_t index;
  for (index = 0;index <DMAX_COLOR_AMOUNT;index++)
  {
    if( (sysLin.RGB_R_LIN10 == SourceColors[index][0]) 
      &&(sysLin.RGB_G_LIN10 == SourceColors[index][1])
      &&(sysLin.RGB_B_LIN10 == SourceColors[index][2]))
    {
      sysLin.RGB_R_LIN10 = KebodaColors[index][0];
      sysLin.RGB_G_LIN10 = KebodaColors[index][1];
      sysLin.RGB_B_LIN10 = KebodaColors[index][2];
      break;
    }
  } 
}




/**
*@details   update LIN slave signal.
*
*@retval    if LIN signal has been updated.
*/
bool_t systemLinCommSignalUpdate(void)
{
  sysLin.CtrlList_LIN10 = l_u16_rd_CtrlList();
  if(((sysLin.CtrlList_LIN10 & savedConfig.groupAddr) == savedConfig.groupAddr)
                  && (sysLin.CtrlList_LIN10 != 0))
  {

      if (0 == l_u8_rd_VehicleTypeInfo())
      {
          sysLin.VehicleTypeInfo = VehicleType_W01;  //0x04;
          if (sysLin.Brightness_LIN10 < savedConfig.MinUsrL[sysLin.VehicleTypeInfo] && sysLin.Brightness_LIN10 != 0)
          {
             sysLin.Brightness_LIN10 = savedConfig.MinUsrL[sysLin.VehicleTypeInfo];
          }
          oldLinData.VehicleTypeInfo = l_u8_rd_VehicleTypeInfo();
      }
          if ((oldLinData.RGB_R_LIN10 != l_u8_rd_RGB_R()) ||
           (oldLinData.RGB_G_LIN10 != l_u8_rd_RGB_G()) ||
           (oldLinData.RGB_B_LIN10 != l_u8_rd_RGB_B()) ||
           (oldLinData.Brightness_LIN10 != l_u8_rd_Brightness()) ||
           (oldLinData.RampTime_LIN10 != l_u8_rd_RampTime())||
           (oldLinData.VehicleTypeInfo != l_u8_rd_VehicleTypeInfo() && l_u8_rd_VehicleTypeInfo() != 0))//ygh add
          {
              
                  sysLin.VehicleTypeInfo = l_u8_rd_VehicleTypeInfo();
                  if (0 == l_u8_rd_VehicleTypeInfo())
                  {
                      sysLin.VehicleTypeInfo = VehicleType_W01;  //0x04;
                  }
                  
                  if( l_u8_rd_Brightness() <= 200)
                  {
                          sysLin.Brightness_LIN10 = l_u8_rd_Brightness();
                  }
                  else
                  {
                          sysLin.Brightness_LIN10 = oldLinData.Brightness_LIN10;
                  }
                  if (sysLin.Brightness_LIN10 < savedConfig.MinUsrL[sysLin.VehicleTypeInfo] && sysLin.Brightness_LIN10 != 0)
                  {
                     sysLin.Brightness_LIN10 = savedConfig.MinUsrL[sysLin.VehicleTypeInfo];
                  }
                  
                  
                  
                  if ((l_u8_rd_RGB_R() != 0) ||
                          (l_u8_rd_RGB_G() != 0) ||
                          (l_u8_rd_RGB_B() != 0))
                  {
                    sysLin.RGB_R_LIN10 = l_u8_rd_RGB_R();
                    sysLin.RGB_G_LIN10 = l_u8_rd_RGB_G();
                    sysLin.RGB_B_LIN10 = l_u8_rd_RGB_B();
                  }
                  else
                  {
                          ;  //color not changed
                  }
                  sysLin.RampTime_LIN10 =  l_u8_rd_RampTime();
                  
                  memcpy(&oldLinData, &sysLin, sizeof(SLinSignals));
                  sysStatus.newLinSignal = btrue;
                         
                  
                  switch(sysLin.VehicleTypeInfo)
                  {
                  case VehicleType_X01_X02:
                      local_ColorMap();
                      break;
                  case VehicleType_X04:
                  case VehicleType_X03:
                  case VehicleType_W01:
                  case VehicleType_W02:
                      break;
                  }
                  
                  return btrue;
          } //signal is updated
  } //group addr is matched

return bfalse;
}

/**
*@details   system LIN communication module prepare to enter sleep.
*
*@retval    None.
*/
void systemLinCommSleep(void)
{
  local_SignalInit();
}

/**
*@details   update LIN slave response signal.
*
*@retval    None.
*/
void systemLinCommRespUpdate(void)
{
  l_u8_wr_HWVerNum2(savedConfig.hardwareVersion[3] - 0x30);
  l_u8_wr_SWVerNum2(softwareVersion[3] - 0x30);
  l_bool_wr_response_error(0);  // revised due to email from customer
}


void local_SignalInit(void)
{
    memset(&oldLinData, 0, sizeof(SLinSignals));
    memset(&sysLin, 0, sizeof(SLinSignals));
}



